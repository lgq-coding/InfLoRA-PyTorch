# InfLoRA-PyTorch
## 1、项目介绍
本项目是基于PyTorch的InfLoRA复现，是《人工智能实践课（初级）》的第一次复现（第二次汇报）内容。<br>
复现的论文是发表在 CVPR 2024 上的《InfLoRA: Interference-Free Low-Rank Adaptation for Continual Learning》，论文的GitHub链接为 https://github.com/liangyanshuo/InfLoRA ，论文的arxiv为 2404.00228 ，感谢作者对代码进行了开源，这为我的复现工作提供了非常重要的帮助，再次感谢！！！<br>
同时，也感谢《人工智能实践课》带给我的与众不同的体验，感谢在学习与复现过程中各位老师和同学的无私帮助！
以下是仓库中的文件结构及作用
```
# 以下包含的文件主要是仓库中和复现相关的重要文件
project/
├── configs/
│ ├── cifar100_inflora.json # 20 epochs 版本
│ └── cifar100_inflora_debug.json # 2 epochs 版本
├── models/ # 具体的模型
├── methods/ # 相关的方法目录，包含 InfLoRA 的实现
├── utills/ # 相关的工具文件
├── 随记.txt # 这是本人在复现过程中的随手记录，包含若干的错误log
├── cifar100_inflora.log # 这是保留的效果最佳的log文件
├── README.md
├── main.py
├── trainer.py
└── requirements.txt # 这是需要的一些包
```
## 2、论文介绍
### 2.1 简要概括
以往的基于已有的PEFT(参数高效微调)的持续学习方法，要么用旧任务的参数适配新任务，要么随机扩展参数，然后适配新任务，这些方法都无法避免新任务对旧任务的干扰。本文引入了防干扰机制，注入一小部分参数，然后重参数化，并证明微调这一部分参数($A_t$)等价于在子空间内($B_t$的行向量的张成空间)微调预训练权重，并且消除了新任务对旧任务的干扰。<br>
### 2.2 具体手段
精心设置了矩阵 $B_t$ : 与以往LoRA方法用高斯分布初始化不同，本文使用新任务梯度空间 $N_t$ 和旧任务梯度空间的正交补空间 $M_t$ ⊥的交集，保证 $B_t$ 落在这个交集内，前者是为了保证学习新任务的能力(塑性)，而后者是为了不干扰旧任务的参数(固性)。<br>
在此基础上，每轮仅更新矩阵 $A_t$ (最开始矩阵A初始为0)，其余的均冻结，目标函数是local CE。<br>
空间的估计方法：①对于新任务，用新任务的输入矩阵估计梯度空间。②而旧任务的梯度空间信息，不能直接获取，通过DualGPM方法保存。③由于维度不一致，所以采取了奇异值分解和top-r奇异值选取的方法。<br>
### 2.3 其他信息
本文的方法同样可以扩展到自监督学习的模型，还能结合类对齐方法。<br>
这篇文章运用线性代数知识，简单而优美，比较直观。
## 3、复现内容以及复现的心路历程
### 3.1 使用的平台
- Google Colab
- GPU: T4(16GB)
- 相关的包请查看 requirements.txt
### 3.2 数据集
- 可以先创造一个 data/ 文件夹
- 对于CIFAR-100，本数据集可以在运行data-loader的过程中自动下载
- 对于ImageNet-R，本数据集可从该网址下载： https://people.eecs.berkeley.edu/~hendrycks/imagenet-r.tar. 解压后放入 data/ 文件夹
- 注意本实验由于计算资源限制，未基于ImageNet-R进行实验，但整体思路一致，只需要替换数据集即可
### 3.3 复现流程与总结：
- 首先更改由于版本因素而导致的报错，保证pytorch和torchvision使用一个较新的版本，而timm使用一个较旧的版本，以避免报错。
- 然后对于numpy形式的向量和tensor的混用进行了修复，统一采取torch版本的，包括矩阵乘法和奇异值分解等方法。
- 由此整体没有很大的错误，但之后在训练到task2的时候，由于索引越界报错，推断是因为没有及时创建LoRA导致，然后借助ai试着进行修复，之后训练过程可以正常进行，但是训练得到的准确率从task2开始急剧下降，且此后的变化趋势明显改变。
- 推断可能是因为没有正确的构建矩阵B，或者是直接利用了空白的LoRA块，之后结合具体的源码进行理解和修复。最终发现在梯度空间更新过程中，将A、B矩阵给搞反了，最终历经约2周的时间把代码给搞通了。
## 4、尝试复现本项目
首先，请按照第3条中提及的内容，以及available_version.ipynb文件，进行基本的数据集、环境、脚本配置。<br>
具体命令可参考.ipynb文件<br>
值得注意的是，在原.ipynb文件中，我先git了原作者的代码仓库，然后替换了相应的代码，相关的代码均在本仓库中<br>
建议想要使用本项目的，可以先基于.ipynb给出的方案进行尝试，也可根据requirements.txt配置环境，然后直接运行本项目<br>
由于本人是第一次复现，可能有很多问题，请大家谅解！！！

